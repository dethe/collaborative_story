<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Collaborative Story Admin</title>
	<style>
		button{
			padding: 20px;
			font-size: 30px;
			border-radius: 10px;
			margin-left: 40px;
		}
	</style>
</head>
<body>
	<h1>Collaborative Story Admin</h1>
	<button class="save-action">Download JSON</button>
	<button class="restore-action">Restore JSON</button>
	<script src='https://cdn.firebase.com/v0/firebase.js'></script>
	<script>
		var ref = new Firebase('https://dethestory.firebaseio.com/');

	// Handler to save to a local file
	//
	function triggerSave(evt){
		ref.child('/').once('value', saveFile);
	}

	function saveFile(snapshot){
	    var title = prompt("Save file as: ");
	    if (!title) return;
	    var json = JSON.stringify(snapshot.val(),null,'  ');
		var file = new Blob([json], {type: 'application/json'});
		var reader = new FileReader();
		reader.onloadend = function(){
			console.log('ready to save');
			var a = document.createElement('a');
			a.href = reader.result;
			a.setAttribute('download', title + '.json');
			document.body.appendChild(a);
			a.click();
		};
		reader.readAsDataURL(file);
	}

	// Handler to load from a local file
	function readFile(file){
		fileName = file.name;
		if (fileName.indexOf('.json', fileName.length - 5) === -1) {
			alert('Not a JSON file');
			return;
		}
		var reader = new FileReader();
		reader.readAsText( file );
		reader.onload = function (evt){
			ref.set(JSON.parse(evt.target.result), function(error){
				if (error){
					console.error('Data was not saved: %o', error);
				}else{
					console.log('Data was saved successfully');
				}
			});
		};
	}

	function loadFile(){
		console.log('loading file');
		var input = document.createElement('input');
		input.setAttribute('type', 'file');
		input.setAttribute('accept', 'application/json');
		if (!input) return;
		input.addEventListener('change', function(evt){
			readFile(input.files[0]);
		});
		input.click();
	}

	document.querySelector('.save-action').addEventListener('click', triggerSave, false);
	document.querySelector('.restore-action').addEventListener('click', loadFile, false);

	</script>
</body>
</html>
