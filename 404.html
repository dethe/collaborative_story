<html>
<head>
<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAS4zRIxFr94g778Y2Fye8BgJUkalz0JkA",
    authDomain: "garden-a048e.firebaseapp.com",
    databaseURL: "https://garden-a048e.firebaseio.com",
    projectId: "garden-a048e",
    storageBucket: "garden-a048e.appspot.com",
    messagingSenderId: "140966453678"
  };
  firebase.initializeApp(config);
</script>
	<script type='text/javascript' src='prefixfree.min.js'></script>
	<link href="style.css" ref="stylesheet" />
	<style>
		
	</style>
</head>
<body>
	<div class="storylet-count"></div>
	<div class="content">
		<div class="show-storylet">
			<h1 class="title"></h1>
			<p class="description"></p>
			<ul class="options">
			</ul>
			<div class="add-action">+</div>
		</div>
		<div class="create-storylet hide">
			<input class="create-title" placeholder="Title" />
			<textarea class="create-description" placeholder="Description" rows="10"></textarea>
			<button class="create-option-action">Create Storylet</button>
		</div>
		<div class="create-content hide">
			<span class="create-content-area">
				<input class="create-option" type="text" placeholder="Option Name"/>
				<button class="create-storylet-action">Ok</button>
			</span>
		</div>
	</div>
	<script>
		// Some suggested refactorings
		// √ 1. Move all CSS properties out of style="" attributes into classes in stylesheet
		// √ 2. Move all CSS properties our of javascript and into classes in stylesheet
		// √ 3. Move DOM finding elements into querySelector or querySelectorAll
		// √ 4. Save variables for commonly used DOM elements
		// 5. Instead of anonymous functions for events, use named, reusable functions
		// √ 6. Use classes instead of ids in CSS
		// 7. Use classes instead of descendant selectors like #someid div
		var ref = new Firebase('https://dethestory.firebaseio.com/');
		var editmode = true; // show the plus button?

		var new_storylet = {
			option: '',
			title: '',
			text: ''
		}
		
		var current;

		ref.child('first').once('value', function(snapshot){
			if(current === undefined){current = snapshot.val()};
			update();
		});

		// Components of the default view
		var showStorylet = document.querySelector('.show-storylet');
		var title = document.querySelector('.title');
		var description = document.querySelector('.description');
		var options = document.querySelector('.options');
		var addAction = document.querySelector('.add-action');

		// Components for adding a new option
		var createContent = document.querySelector('.create-content');
		var createOption = document.querySelector('.create-option');
		var createStoryletAction = document.querySelector('.create-storylet-action');

		// Components for filling in the new option page
		var createStorylet = document.querySelector('.create-storylet');
		var createTitle = document.querySelector('.create-title');
		var createDescription = document.querySelector('.create-description');
		var createOptionAction = document.querySelector('.create-option-action');

		// This is always shown
		var storyletCount = document.querySelector('.storylet-count');

		// if(editmode){
		// 	createContent.classList.remove('hide');
		// }

		addAction.addEventListener('click', addActionHandler, false);

		function addActionHandler(evt){
			// showStorylet.classList.add('hide');
			createContent.classList.remove('hide');
			addAction.classList.add('hide');
			createOption.focus();
		}

		createStoryletAction.onclick = function(){
			var value = createOption.value;
			createOption.value = '';
			if(value.length > 0){
				new_storylet.option = value;
				createContent.classList.add('hide');
				showStorylet.classList.add('hide');
				addAction.classList.remove('hide');
				createStorylet.classList.remove('hide');
				createTitle.value = '';
				createDescription.value = '';
				createTitle.focus();
			}
		}

		createOptionAction.onclick = function(){
			new_storylet.title = createTitle.value;
			new_storylet.text = createDescription.value;
			createStorylet.classList.add('hide');
			showStorylet.classList.remove('hide');
			ref.child('storylets/'+current+'/options').push([new_storylet.option, new_storylet.title])

			ref.child('storylets/'+new_storylet.title).set({
				"options":[],
				"text":new_storylet.text
			})

			update();
		}

		function update(){

			options.innerHTML = "";

			ref.child('storylets/'+current+'/options').off();
			ref.child('storylets/'+current+'/options').on('child_added', function(snapshot){
				var element = document.createElement('li');
				var a = document.createElement('a');
				element.appendChild(a);
				a.textContent = snapshot.val()[0];
				a.setAttribute('href', snapshot.val()[1]);
				a.onclick = function(evt){
					evt.preventDefault();
					ref.child('storylets/'+current+'/options').off();
					current = a.getAttribute('href');
					update();
				};
				options.appendChild(element);
			});

			ref.child('storylets/'+current).once('value', function(snapshot){
				title.textContent = current;
				description.textContent = snapshot.child('text').val();
			});
		}

		ref.child('storylets').on('value', function(snapshot){
			storyletCount.textContent = Object.keys(snapshot.val()).length + ' total storylets';
		})
	</script>
</body>
</html>
